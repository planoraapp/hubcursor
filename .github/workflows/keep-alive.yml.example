# ğŸ”„ GitHub Actions - Supabase Keep-Alive (ALTERNATIVA)
#
# Este Ã© um arquivo de exemplo caso vocÃª queira usar GitHub Actions
# ao invÃ©s do Vercel Cron Jobs.
#
# Para ativar:
# 1. Renomeie este arquivo para: .github/workflows/keep-alive.yml
# 2. Adicione o secret SUPABASE_ANON_KEY no GitHub:
#    - VÃ¡ em: Settings > Secrets and variables > Actions
#    - Click em "New repository secret"
#    - Name: SUPABASE_ANON_KEY
#    - Value: sua chave anon do Supabase
# 3. Commit e push para o repositÃ³rio

name: Supabase Keep-Alive

on:
  schedule:
    # Executa todos os dias Ã s 3 AM UTC
    # Formato: "minuto hora dia mÃªs dia-da-semana"
    - cron: '0 3 * * *'
  
  # Permite execuÃ§Ã£o manual via GitHub Actions UI
  workflow_dispatch:

jobs:
  keep-alive:
    name: Ping Supabase Services
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Š Check Database Health
        run: |
          echo "ğŸ” Checking Supabase database..."
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X GET "https://wueccgeizznjmjgmuscy.supabase.co/rest/v1/habbo_accounts?limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          if [ "$http_status" = "200" ]; then
            echo "âœ… Database is healthy (HTTP $http_status)"
          else
            echo "âš ï¸ Database returned HTTP $http_status"
          fi

      - name: ğŸŒ Ping Global Feed Function
        run: |
          echo "ğŸ” Pinging global feed Edge Function..."
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://wueccgeizznjmjgmuscy.supabase.co/functions/v1/habbo-global-feed" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"hotel":"br","limit":5}')
          
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          if [ "$http_status" = "200" ]; then
            echo "âœ… Global feed function is healthy (HTTP $http_status)"
          else
            echo "âš ï¸ Global feed function returned HTTP $http_status"
          fi

      - name: ğŸ‘¤ Ping Profile Function
        run: |
          echo "ğŸ” Pinging profile Edge Function..."
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST "https://wueccgeizznjmjgmuscy.supabase.co/functions/v1/habbo-complete-profile" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -d '{"hotel":"br","habbo_name":"test"}')
          
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          # Profile pode retornar 404 se usuÃ¡rio nÃ£o existe, mas isso indica que a funÃ§Ã£o estÃ¡ ativa
          if [ "$http_status" -lt "500" ]; then
            echo "âœ… Profile function is healthy (HTTP $http_status)"
          else
            echo "âš ï¸ Profile function returned HTTP $http_status"
          fi

      - name: ğŸ” Check Auth System
        run: |
          echo "ğŸ” Checking authentication system..."
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X GET "https://wueccgeizznjmjgmuscy.supabase.co/auth/v1/health" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}")
          
          http_status=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          if [ "$http_status" = "200" ]; then
            echo "âœ… Auth system is healthy (HTTP $http_status)"
          else
            echo "âš ï¸ Auth system returned HTTP $http_status"
          fi

      - name: ğŸ“ Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ Keep-alive routine completed!"
          echo "ğŸ“… Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â° Next run: Tomorrow at 3:00 AM UTC"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

