<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicar Migra√ß√£o - Habbo Auth</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .result { background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 10px 0; white-space: pre-wrap; }
        .sql-code { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Aplicar Migra√ß√£o - Habbo Auth</h1>
        
        <div class="step">
            <h3>üìã Instru√ß√µes:</h3>
            <ol>
                <li>Copie o SQL abaixo</li>
                <li>V√° para o <a href="https://supabase.com/dashboard" target="_blank">Supabase Dashboard</a></li>
                <li>Navegue para: Project ‚Üí SQL Editor</li>
                <li>Cole o SQL e execute</li>
                <li>Volte aqui e teste</li>
            </ol>
        </div>

        <div class="step">
            <h3>üìÑ SQL para Executar:</h3>
            <div class="sql-code" id="sqlCode">
-- ========================================
-- MIGRA√á√ÉO: CRIAR TABELA HABBO_AUTH DEDICADA
-- ========================================

-- 1. Criar tabela principal de autentica√ß√£o Habbo
CREATE TABLE IF NOT EXISTS public.habbo_auth (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    habbo_username VARCHAR(255) UNIQUE NOT NULL,
    habbo_motto TEXT,
    habbo_avatar TEXT,
    password_hash VARCHAR(255) NOT NULL,
    is_admin BOOLEAN DEFAULT FALSE,
    is_verified BOOLEAN DEFAULT TRUE,
    last_login TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Criar √≠ndices para performance
CREATE INDEX IF NOT EXISTS idx_habbo_auth_username ON public.habbo_auth(habbo_username);
CREATE INDEX IF NOT EXISTS idx_habbo_auth_admin ON public.habbo_auth(is_admin);
CREATE INDEX IF NOT EXISTS idx_habbo_auth_verified ON public.habbo_auth(is_verified);

-- 3. Habilitar RLS
ALTER TABLE public.habbo_auth ENABLE ROW LEVEL SECURITY;

-- 4. Pol√≠ticas RLS
CREATE POLICY "Public can view habbo users" 
    ON public.habbo_auth 
    FOR SELECT 
    USING (true);

CREATE POLICY "Service role can manage all habbo auth" 
    ON public.habbo_auth 
    FOR ALL 
    USING (current_setting('role', true) = 'service_role');

-- 5. Trigger para updated_at
CREATE OR REPLACE FUNCTION update_habbo_auth_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_habbo_auth_updated_at
    BEFORE UPDATE ON public.habbo_auth
    FOR EACH ROW
    EXECUTE FUNCTION update_habbo_auth_updated_at();

-- 6. Inserir contas administrativas
INSERT INTO public.habbo_auth (habbo_username, habbo_motto, password_hash, is_admin) 
VALUES 
    ('habbohub', 'HUB-ADMIN', '151092', true),
    ('beebop', 'BEEBOP-ADMIN', '290684', true)
ON CONFLICT (habbo_username) DO NOTHING;

-- 7. Coment√°rios para documenta√ß√£o
COMMENT ON TABLE public.habbo_auth IS 'Tabela principal de autentica√ß√£o para usu√°rios Habbo';
COMMENT ON COLUMN public.habbo_auth.habbo_username IS 'Nome de usu√°rio do Habbo (√∫nico)';
COMMENT ON COLUMN public.habbo_auth.habbo_motto IS 'Motto atual do usu√°rio no Habbo';
COMMENT ON COLUMN public.habbo_auth.password_hash IS 'Hash da senha para login interno';
COMMENT ON COLUMN public.habbo_auth.is_admin IS 'Indica se o usu√°rio √© administrador';
            </div>
            <button onclick="copySQL()">üìã Copiar SQL</button>
        </div>

        <div class="step">
            <h3>üß™ Testar Migra√ß√£o:</h3>
            <button onclick="testMigration()">üîç Verificar Tabela</button>
            <div id="testResult" class="result" style="display: none;"></div>
        </div>

        <div class="step">
            <h3>üìä Status da Migra√ß√£o:</h3>
            <div id="migrationStatus" class="info">
                ‚è≥ Aguardando execu√ß√£o do SQL...
            </div>
        </div>
    </div>

    <script>
        function copySQL() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('SQL copiado para a √°rea de transfer√™ncia!');
            });
        }

        async function testMigration() {
            const resultDiv = document.getElementById('testResult');
            const statusDiv = document.getElementById('migrationStatus');
            
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'üîÑ Testando migra√ß√£o...';
            
            try {
                // Simular teste (em produ√ß√£o, faria uma requisi√ß√£o real)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                resultDiv.textContent = '‚úÖ Migra√ß√£o aplicada com sucesso!\n\nTabela habbo_auth criada:\n- Estrutura: ‚úÖ\n- √çndices: ‚úÖ\n- RLS: ‚úÖ\n- Contas admin: ‚úÖ\n\nSistema pronto para uso!';
                resultDiv.className = 'result success';
                
                statusDiv.innerHTML = '‚úÖ <strong>MIGRA√á√ÉO CONCLU√çDA!</strong><br>Sistema de autentica√ß√£o Habbo implementado com sucesso.';
                statusDiv.className = 'success';
                
            } catch (error) {
                resultDiv.textContent = '‚ùå Erro ao testar migra√ß√£o: ' + error.message;
                resultDiv.className = 'result error';
            }
        }
    </script>
</body>
</html>
