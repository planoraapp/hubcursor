<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicar Migra√ß√£o - Habbo Users</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .result { background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 10px 0; white-space: pre-wrap; }
        .sql-code { background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Aplicar Migra√ß√£o - Tabela habbo_users</h1>
        
        <div class="step">
            <h3>üìã Instru√ß√µes:</h3>
            <ol>
                <li>Copie o SQL abaixo</li>
                <li>V√° para o <a href="https://supabase.com/dashboard" target="_blank">Supabase Dashboard</a></li>
                <li>Navegue para: Project ‚Üí SQL Editor</li>
                <li>Cole o SQL e execute</li>
                <li>Volte aqui e teste</li>
            </ol>
        </div>

        <div class="step">
            <h3>üìÑ SQL para Executar:</h3>
            <div class="sql-code" id="sqlCode">
-- ========================================
-- MIGRA√á√ÉO PARA CRIAR TABELA HABBO_USERS COMPLETA
-- ========================================

-- 1. Dropar tabela existente se existir (cuidado!)
-- DROP TABLE IF EXISTS public.habbo_users CASCADE;

-- 2. Criar nova tabela habbo_users com estrutura completa
CREATE TABLE IF NOT EXISTS public.habbo_users (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  habbo_name text NOT NULL,
  habbo_id text NOT NULL,
  hotel text NOT NULL DEFAULT 'br',
  figure_string text,
  motto text,
  is_online boolean DEFAULT false,
  is_admin boolean DEFAULT false,
  password_hash text,
  profile_visible boolean DEFAULT true,
  member_since timestamp with time zone,
  last_access timestamp with time zone DEFAULT now(),
  current_level integer DEFAULT 1,
  total_experience integer DEFAULT 0,
  star_gem_count integer DEFAULT 0,
  selected_badges jsonb DEFAULT '[]'::jsonb,
  badges_data jsonb DEFAULT '{}'::jsonb,
  groups_data jsonb DEFAULT '{}'::jsonb,
  friends_data jsonb DEFAULT '{}'::jsonb,
  rooms_data jsonb DEFAULT '{}'::jsonb,
  achievements_data jsonb DEFAULT '{}'::jsonb,
  full_api_data jsonb DEFAULT '{}'::jsonb,
  data_collected_at timestamp with time zone DEFAULT now(),
  data_source text DEFAULT 'habbo.com.br',
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  
  -- √çndices √∫nicos
  CONSTRAINT unique_habbo_name_hotel UNIQUE (habbo_name, hotel),
  CONSTRAINT unique_habbo_id_hotel UNIQUE (habbo_id, hotel)
);

-- 3. Habilitar RLS
ALTER TABLE public.habbo_users ENABLE ROW LEVEL SECURITY;

-- 4. Pol√≠ticas RLS
CREATE POLICY IF NOT EXISTS "Public can view habbo users"
  ON public.habbo_users
  FOR SELECT
  TO PUBLIC
  USING (true);

CREATE POLICY IF NOT EXISTS "Users can insert their own data"
  ON public.habbo_users
  FOR INSERT
  TO PUBLIC
  WITH CHECK (true);

CREATE POLICY IF NOT EXISTS "Users can update their own data"
  ON public.habbo_users
  FOR UPDATE
  TO PUBLIC
  USING (true)
  WITH CHECK (true);

-- 5. √çndices para performance
CREATE INDEX IF NOT EXISTS idx_habbo_users_name_hotel ON public.habbo_users (habbo_name, hotel);
CREATE INDEX IF NOT EXISTS idx_habbo_users_habbo_id ON public.habbo_users (habbo_id);
CREATE INDEX IF NOT EXISTS idx_habbo_users_is_admin ON public.habbo_users (is_admin);
CREATE INDEX IF NOT EXISTS idx_habbo_users_is_online ON public.habbo_users (is_online);

-- 6. Trigger para updated_at
CREATE OR REPLACE FUNCTION update_habbo_users_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_habbo_users_updated_at
  BEFORE UPDATE ON public.habbo_users
  FOR EACH ROW
  EXECUTE FUNCTION update_habbo_users_updated_at();

-- 7. Inserir contas de admin
INSERT INTO public.habbo_users (
  habbo_name,
  habbo_id,
  hotel,
  figure_string,
  motto,
  is_admin,
  is_online,
  password_hash,
  profile_visible
) VALUES 
(
  'habbohub',
  'hhbr-81b7220d11b7a21997226bf7cfcbad51',
  'br',
  'hr-829-45.hd-208-1.ch-3022-90-91.lg-275-82.sh-3524-66-1408.wa-3661-66-1408',
  'HUB-QQ797',
  true,
  false,
  '151092',
  false
),
(
  'beebop',
  'hhbr-beebop-id',
  'br',
  'hr-100-0.hd-180-1',
  'BEEBOP-MOTTO',
  true,
  false,
  '290684',
  true
)
ON CONFLICT (habbo_name, hotel) DO UPDATE SET
  habbo_id = EXCLUDED.habbo_id,
  figure_string = EXCLUDED.figure_string,
  motto = EXCLUDED.motto,
  is_admin = EXCLUDED.is_admin,
  password_hash = EXCLUDED.password_hash,
  updated_at = now();

-- 8. Verificar se foi criado corretamente
SELECT 'Tabela habbo_users criada com sucesso!' as status;
SELECT habbo_name, habbo_id, is_admin, password_hash FROM public.habbo_users;
            </div>
            <button onclick="copySQL()">üìã Copiar SQL</button>
        </div>

        <div class="step">
            <h3>üß™ Testar ap√≥s aplicar migra√ß√£o:</h3>
            <button onclick="testMigration()">Testar Tabela</button>
            <div id="testResult" class="result"></div>
        </div>

        <div class="step">
            <h3>üîó Links √öteis:</h3>
            <ul>
                <li><a href="https://supabase.com/dashboard" target="_blank">Supabase Dashboard</a></li>
                <li><a href="https://supabase.com/dashboard/project/wueccgeizznjmjgmuscy/sql" target="_blank">SQL Editor (direto)</a></li>
                <li><a href="test-simple-auth.html" target="_blank">Teste Simples</a></li>
            </ul>
        </div>
    </div>

    <script>
        function copySQL() {
            const sqlCode = document.getElementById('sqlCode').textContent;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('SQL copiado para a √°rea de transfer√™ncia!');
            });
        }

        async function testMigration() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = 'üîÑ Testando tabela habbo_users...';
            
            try {
                const response = await fetch('https://wueccgeizznjmjgmuscy.supabase.co/rest/v1/habbo_users?select=habbo_name,habbo_id,is_admin,password_hash', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1ZWNjZ2VpenpqbWpnbXVzY3kiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTczODA0NzQ0MCwiZXhwIjoyMDUzNjIzNDQwfQ.8Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind1ZWNjZ2VpenpqbWpnbXVzY3kiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTczODA0NzQ0MCwiZXhwIjoyMDUzNjIzNDQwfQ.8Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q7Q'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<span class="success">‚úÖ Tabela habbo_users funcionando!
üìä ${data.length} registros encontrados:

${data.map(user => `üë§ ${user.habbo_name} (${user.habbo_id}) - Admin: ${user.is_admin} - Senha: ${user.password_hash}`).join('\n')}</span>`;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `<span class="error">‚ùå Erro: ${error}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">‚ùå Erro: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
